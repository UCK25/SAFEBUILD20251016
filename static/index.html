<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeBuild - Web</title>
  <style>
    body { background:#0b1220; color:#e6eef8; font-family:Arial, sans-serif; }
    .container { max-width:900px; margin:20px auto; }
  video, img { width:100%; max-height:640px; background:#222; display:block; }
  button { margin-top:8px; padding:10px 16px; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    #status { margin-top:8px; color:#a8c0ff }
  </style>
</head>
<body>
  <div class="container">
  <!-- Intentionally minimal when embedded in dashboard. -->

    <div class="row" style="align-items:flex-start;">
      <div class="col" style="flex:0 0 40%;">
        <h3>Preview (local)</h3>
        <video id="video" autoplay playsinline muted style="width:100%; height:360px; background:#222; object-fit:cover;"></video>
      </div>
      <div class="col" style="flex:1 1 60%;">
        <h3>Resultado (annotado)</h3>
        <canvas id="annotatedCanvas" style="width:100%; height:560px; background:#111; display:block;" ></canvas>
      </div>
    </div>

    <div style="margin-top:8px; display:none">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <span id="status">Idle</span>
    </div>

    <p style="margin-top:12px; font-size:0.9em; color:#99a">Nota: Si no funciona la cámara en la IP pública, abre la URL desde el mismo equipo (localhost) o usa HTTPS.</p>
  </div>

<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');
let stream = null;
let intervalId = null;

async function start() {
  status.textContent = 'Solicitando cámara...';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false });
    video.srcObject = stream;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    status.textContent = 'Cámara iniciada. Enviando frames...';
    // crear canvas para capturar frames y para render annotated de manera suave
    const captureCanvas = document.createElement('canvas');
    const captureCtx = captureCanvas.getContext('2d');
    captureCanvas.width = 1280; captureCanvas.height = 720;
  const annotatedCanvas = document.getElementById('annotatedCanvas');
  // set canvas internal size to capture size for sharp rendering
  annotatedCanvas.width = captureCanvas.width;
  annotatedCanvas.height = captureCanvas.height;
  const annotatedCtx = annotatedCanvas.getContext('2d');

    let pendingFrame = null;
    async function sendFrame(){
      try{
        captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
        const blob = await new Promise(res => captureCanvas.toBlob(res, 'image/jpeg', 0.8));
        if (!blob) return;
        const form = new FormData(); form.append('frame', blob, 'frame.jpg');
        const startTs = performance.now();
        const resp = await fetch('/detect', { method: 'POST', body: form });
        if (!resp.ok) { status.textContent = 'Error servidor'; return; }
        const imgBlob = await resp.blob();
        const bitmap = await createImageBitmap(imgBlob);
        pendingFrame = {bitmap, latency: Math.round(performance.now()-startTs)};
      }catch(e){ console.error(e); status.textContent = 'Error: '+e.message }
    }

    // keep sending frames at a moderate rate and render with requestAnimationFrame for smoothness
    intervalId = setInterval(sendFrame, 300); // enviar cada 300ms

    function renderLoop(){
      if(pendingFrame){
        const b = pendingFrame.bitmap;
        // draw bitmap scaled to canvas
        annotatedCtx.clearRect(0,0,annotatedCanvas.width, annotatedCanvas.height);
        annotatedCtx.drawImage(b, 0, 0, annotatedCanvas.width, annotatedCanvas.height);
        status.textContent = `Última latencia: ${pendingFrame.latency} ms`;
        pendingFrame = null;
      } else {
        // if no annotated frame available yet, draw live video into result area for smoothness
        try{
          annotatedCtx.clearRect(0,0,annotatedCanvas.width, annotatedCanvas.height);
          annotatedCtx.drawImage(video, 0, 0, annotatedCanvas.width, annotatedCanvas.height);
        }catch(e){ /* ignore if video not ready */ }
      }
      requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);
  } catch (e) {
    console.error(e);
    status.textContent = 'No se pudo iniciar la cámara: ' + e.message;
  }
}

function stop() {
  if (intervalId) clearInterval(intervalId);
  intervalId = null;
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
  }
  startBtn.disabled = false;
  stopBtn.disabled = true;
  status.textContent = 'Detenido';
}

// Auto-start when loaded (dashboard embeds this page)
window.addEventListener('load', ()=>{
  // try to start automatically; if blocked, show status
  start().catch(e=>{ console.warn('auto-start failed', e); });
});

// Note: controls are presented in the dashboard. This embedded page is intentionally minimal.
</script>
</body>
</html>