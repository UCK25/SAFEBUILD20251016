<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeBuild - Gestionar Usuarios</title>
  <style>
    body { background:#071023; color:#e6eef8; font-family:Arial, sans-serif; }
    .container { max-width:1100px; margin:16px auto; }
    table { width:100%; border-collapse:collapse; margin-top:8px }
    th, td { padding:8px; border-bottom:1px solid #123; text-align:left }
    th { background:#091428 }
    button { padding:6px 10px; margin-right:6px }
    .top { display:flex; gap:8px; align-items:center }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>Gestionar Usuarios</h1>
      <div style="margin-left:auto">
        <button id="backBtn">Volver</button>
      </div>
    </div>

    <div style="display:flex; gap:12px; align-items:flex-start;">
      <div style="flex:2">
        <h3>Usuarios</h3>
        <table id="usersTable">
          <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>QR</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="width:360px;">
        <h3>Crear Usuario</h3>
        <div style="background:#081428;padding:12px;border-radius:6px">
          <label>Usuario<br><input id="new_username" style="width:100%"/></label><br><br>
          <label>Contrase√±a<br><input id="new_password" type="password" style="width:100%"/></label><br><br>
          <label>Rol<br>
            <select id="new_role" style="width:100%">
              <option value="guest">guest</option>
              <option value="supervisor">supervisor</option>
              <option value="admin">admin</option>
            </select>
          </label><br><br>
          <label>QR (opcional)<br><input id="new_qr" style="width:100%"/></label><br><br>
          <div style="text-align:right"><button id="createBtn">Crear</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
let currentUser = null;
document.getElementById('backBtn').addEventListener('click', ()=>{ window.location='/dashboard'; });

async function fetchUsers(){
  const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML='';
  try{
  const res = await fetch('/api/users', { credentials: 'include' });
    if(!res.ok){
      tbody.innerHTML = '<tr><td colspan="5">No autorizado. Autentique para ver usuarios.</td></tr>';
      return;
    }
    const data = await res.json();
    if(!data || !data.length){
      tbody.innerHTML = '<tr><td colspan="5">No hay usuarios o no tiene permisos para verlos.</td></tr>';
      return;
    }
    data.forEach(u=>{
      const tr = document.createElement('tr');
      const masked = '********';
      tr.innerHTML = `<td>${u.id}</td><td>${u.username}</td><td>${u.role}</td><td>${masked}</td>`;
      const actions = document.createElement('td');
  const dl = document.createElement('button'); dl.textContent='Descargar QR'; dl.onclick = async ()=>{ try{ const resp = await fetch(`/api/download_qr/${u.id}`, { credentials: 'include' }); if(!resp.ok) return alert('No permitido'); const blob = await resp.blob(); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download=`${u.username}_qr.png`; document.body.appendChild(a); a.click(); a.remove(); }catch(e){ alert(e.message) } };
      actions.appendChild(dl);
      // edit username/qr if permissions (admin or supervisor or self)
      const curRole = (currentUser||{}).role || '';
      if(currentUser && (parseInt(currentUser.id) === parseInt(u.id) || ['admin','supervisor'].includes(curRole))){
        const edit = document.createElement('button'); edit.textContent='Editar'; edit.onclick = ()=>{ editUser(u); };
        actions.appendChild(edit);
      }
      // delete button following rules: admin can delete non-admins, supervisor can delete guests, cannot delete self
      let canDelete = false;
      if(currentUser){
        const curId = parseInt(currentUser.id);
        const curRoleLow = (currentUser.role||'').toLowerCase();
        if(curId !== parseInt(u.id)){
          if(curRoleLow === 'admin' && (u.role||'').toLowerCase() !== 'admin') canDelete = true;
          if(curRoleLow === 'supervisor' && (u.role||'').toLowerCase() === 'guest') canDelete = true;
        }
      }
      if(canDelete){
        const del = document.createElement('button'); del.textContent='Eliminar'; del.style.background='#8b2c2c'; del.onclick = ()=>{ if(confirm('Eliminar usuario '+u.username+'?')) deleteUser(u); };
        actions.appendChild(del);
      }
      tr.appendChild(actions);
      tbody.appendChild(tr);
    });
  }catch(e){
    tbody.innerHTML = '<tr><td colspan="5">Error al recuperar usuarios.</td></tr>';
    console.warn('fetchUsers error', e);
  }
}

function editUser(u){
  const newName = prompt('Nuevo username', u.username); if(newName===null) return;
  const newQr = prompt('QR (dejar en blanco para no cambiar)', '')
  const body = { username: newName };
  if(newQr !== null && newQr !== '') body.qr_code = newQr;
  fetch('/api/users/'+u.id, { method:'PUT', credentials: 'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) }).then(async r=>{ if(!r.ok){ const txt = await r.text(); alert('Error: '+txt); } else { alert('Actualizado'); fetchUsers(); } });
}

async function createUser(){
  const username = document.getElementById('new_username').value.trim();
  const password = document.getElementById('new_password').value;
  const role = document.getElementById('new_role').value;
  const qr = document.getElementById('new_qr').value.trim() || null;
  if(!username || !password) return alert('username y password son requeridos');
  try{
    const res = await fetch('/api/users', { method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({username, password, role, qr_code: qr}) });
    if(!res.ok){ const t = await res.text(); return alert('Error: '+t); }
    alert('Usuario creado');
    document.getElementById('new_username').value=''; document.getElementById('new_password').value=''; document.getElementById('new_qr').value='';
    fetchUsers();
  }catch(e){ alert(e.message || e); }
}

async function deleteUser(u){
  try{
    const res = await fetch('/api/users/'+u.id, { method:'DELETE', credentials:'include' });
    if(!res.ok){ const t = await res.text(); return alert('Error: '+t); }
    alert('Eliminado');
    fetchUsers();
  }catch(e){ alert(e.message || e); }
}

// QR / mapping UI removed: this functionality is internal and intentionally not exposed in the Gestionar UI.

// init
async function init(){
  try{
    const me = await fetch('/api/me', { credentials: 'include' });
    if(me.ok){ const jd = await me.json(); if(jd.ok) currentUser = jd.user; }
  }catch(e){ /* ignore */ }
  // adjust role select availability: supervisors cannot create admin
  if(currentUser && (currentUser.role||'').toLowerCase() === 'supervisor'){
    const opt = document.querySelector('#new_role option[value="admin"]'); if(opt) opt.disabled = true;
  }
  // hide create panel for guests or unauthenticated
  if(!currentUser || (currentUser.role||'').toLowerCase() === 'guest'){
    document.getElementById('createBtn').disabled = true;
    document.getElementById('new_username').disabled = true;
    document.getElementById('new_password').disabled = true;
    document.getElementById('new_role').disabled = true;
    document.getElementById('new_qr').disabled = true;
  }
  document.getElementById('createBtn').addEventListener('click', createUser);
  fetchUsers();
}
init();
</script>
</body>
</html>
